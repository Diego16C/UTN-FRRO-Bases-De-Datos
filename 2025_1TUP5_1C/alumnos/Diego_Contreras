DROP DATABASE IF EXISTS empresa_tecnologia;
CREATE DATABASE empresa_tecnologia CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE empresa_tecnologia;

CREATE TABLE clientes (
    id_cliente INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL,
    apellido VARCHAR(50) NOT NULL,
    dni VARCHAR(15) UNIQUE NOT NULL,
    email VARCHAR(100),
    fecha_registro DATE NOT NULL
);

CREATE TABLE productos (
    id_producto INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    categoria VARCHAR(50) NOT NULL,
    precio DECIMAL(10,2) NOT NULL CHECK (precio > 0),
    stock INT NOT NULL CHECK (stock >= 0)
);

CREATE TABLE empleados (
    id_empleado INT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL,
    apellido VARCHAR(50) NOT NULL,
    puesto VARCHAR(50),
    salario DECIMAL(10,2) NOT NULL CHECK (salario > 0)
);

CREATE TABLE ventas (
    id_venta INT AUTO_INCREMENT PRIMARY KEY,
    fecha_venta DATE NOT NULL,
    id_cliente INT NOT NULL,
    id_empleado INT NOT NULL,
    FOREIGN KEY (id_cliente) REFERENCES clientes(id_cliente),
    FOREIGN KEY (id_empleado) REFERENCES empleados(id_empleado)
);

CREATE TABLE detalle_venta (
    id_venta INT NOT NULL,
    id_producto INT NOT NULL,
    cantidad INT NOT NULL CHECK (cantidad > 0),
    precio_unitario DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (id_venta) REFERENCES ventas(id_venta),
    FOREIGN KEY (id_producto) REFERENCES productos(id_producto)
);

SELECT 
    c.nombre AS nombre_cliente,
    c.apellido AS apellido_cliente,
    v.fecha_venta,
    e.nombre AS nombre_empleado,
    e.apellido AS apellido_empleado
FROM ventas v
JOIN clientes c ON v.id_cliente = c.id_cliente
JOIN empleados e ON v.id_empleado = e.id_empleado;


SELECT 
    p.nombre AS producto,
    dv.cantidad,
    dv.precio_unitario,
    v.fecha_venta
FROM detalle_venta dv
JOIN productos p ON dv.id_producto = p.id_producto
JOIN ventas v ON dv.id_venta = v.id_venta
ORDER BY v.fecha_venta;

SELECT 
    p.nombre AS producto,
    p.stock,
    SUM(dv.cantidad) AS total_vendido
FROM productos p
LEFT JOIN detalle_venta dv ON p.id_producto = dv.id_producto
GROUP BY p.id_producto, p.nombre, p.stock;

SELECT 
    e.nombre AS nombre_empleado,
    e.apellido AS apellido_empleado,
    SUM(dv.cantidad * dv.precio_unitario) AS total_facturado
FROM empleados e
JOIN ventas v ON e.id_empleado = v.id_empleado
JOIN detalle_venta dv ON v.id_venta = dv.id_venta
GROUP BY e.id_empleado, e.nombre, e.apellido
ORDER BY total_facturado DESC;

SELECT 
    c.nombre,
    c.apellido,
    COUNT(v.id_venta) AS cantidad_ventas
FROM clientes c
JOIN ventas v ON c.id_cliente = v.id_cliente
GROUP BY c.id_cliente, c.nombre, c.apellido
HAVING COUNT(v.id_venta) > 2
ORDER BY c.apellido, c.nombre;
